import os
import time
import socket
import psutil
import json
from datetime import datetime
from pynput import keyboard

# Diret√≥rio de logs
LOG_DIR = os.path.expanduser("~/simulador_seguro/logs")
os.makedirs(LOG_DIR, exist_ok=True)

# Fun√ß√µes utilit√°rias
def log_event(nivel, mensagem):
    caminho = os.path.join(LOG_DIR, "eventos.log")
    with open(caminho, "a") as f:
        f.write(f"[{datetime.now()}] {nivel}: {mensagem}\n")

def salvar_json(nome, dados):
    caminho = os.path.join(LOG_DIR, nome)
    with open(caminho, "w") as f:
        json.dump(dados, f, indent=2)

# 1. Monitoramento de processos
def monitorar_processos():
    print("üîç Monitorando processos...")
    processos = [p.info for p in psutil.process_iter(['pid', 'name', 'username'])]
    salvar_json("processos.json", processos)
    log_event("INFO", "Processos monitorados com sucesso.")

    suspeitos = [p for p in processos if p['name'] in ['powershell.exe', 'cmd.exe', 'python.exe']]
    if suspeitos:
        log_event("WARNING", f"Processos suspeitos detectados: {suspeitos}")
        print("‚ö†Ô∏è Processos suspeitos encontrados.")

# 2. Escaneamento de portas
def escanear_portas(host="127.0.0.1"):
    print(f"üåê Escaneando portas em {host}...")
    abertas = []
    for porta in range(20, 1025):
        try:
            s = socket.socket()
            s.settimeout(0.2)
            s.connect((host, porta))
            abertas.append(porta)
            s.close()
        except:
            pass
    salvar_json("portas_abertas.json", abertas)
    log_event("INFO", f"Portas abertas: {abertas}")
    print(f"‚úÖ Portas abertas: {len(abertas)}")

# 3. Simula√ß√£o de persist√™ncia
def simular_persistencia():
    caminho = os.path.join(LOG_DIR, "persistencia.txt")
    if not os.path.exists(caminho):
        with open(caminho, "w") as f:
            f.write("Simula√ß√£o de persist√™ncia ativa.")
        log_event("INFO", "Arquivo de persist√™ncia criado.")
        print(f"üìÅ Persist√™ncia simulada em: {caminho}")
    else:
        log_event("INFO", "Arquivo de persist√™ncia j√° existia.")
        print("üìÅ Persist√™ncia j√° simulada.")

# 4. Captura de teclado (educacional)
def iniciar_captura_teclado():
    print("‚å®Ô∏è Capturando teclas (pressione ESC para sair)...")

    def ao_pressionar(tecla):
        log_event("INFO", f"Tecla: {tecla}")
        if tecla == keyboard.Key.esc:
            return False

    with keyboard.Listener(on_press=ao_pressionar) as listener:
        listener.join()

# 5. Detec√ß√£o de atividade de rede
def detectar_atividade_rede():
    conexoes = psutil.net_connections()
    ativos = [c for c in conexoes if c.status == 'ESTABLISHED']
    salvar_json("conexoes_ativas.json", [str(c) for c in ativos])
    log_event("INFO", f"Conex√µes de rede ativas: {len(ativos)}")
    print(f"üåê Conex√µes de rede ativas: {len(ativos)}")

# Menu interativo
def menu():
    opcoes = {
        "1": ("Monitorar processos", monitorar_processos),
        "2": ("Escanear portas", escanear_portas),
        "3": ("Simular persist√™ncia", simular_persistencia),
        "4": ("Capturar teclado", iniciar_captura_teclado),
        "5": ("Detectar rede", detectar_atividade_rede),
        "0": ("Sair", exit)
    }

    while True:
        print("\nüß™ Menu de Simula√ß√£o Segura")
        for k, (desc, _) in opcoes.items():
            print(f"{k} - {desc}")
        escolha = input("Escolha uma op√ß√£o: ").strip()
        if escolha in opcoes:
            try:
                opcoes[escolha][1]()
            except Exception as e:
                log_event("ERROR", f"Erro ao executar {opcoes[escolha][0]}: {e}")
                print(f"‚ùå Erro: {e}")
        else:
            print("Op√ß√£o inv√°lida.")

if __name__ == "__main__":
    menu()
